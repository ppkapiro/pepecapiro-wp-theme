name: API Automation Trigger
on:
  repository_dispatch:
    types: [automation-trigger]
  workflow_dispatch:
    inputs:
      action:
        description: 'Acci√≥n a ejecutar'
        required: true
        type: choice
        options:
          - sync-content
          - rebuild-dashboard
          - run-verifications
          - cleanup-test-data
      target:
        description: 'Objetivo (opcional)'
        required: false
        type: string

permissions:
  contents: write
  issues: write

jobs:
  trigger:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Validar acci√≥n
        id: validate
        run: |
          ACTION="${{ github.event.inputs.action || github.event.client_payload.action }}"
          TARGET="${{ github.event.inputs.target || github.event.client_payload.target || 'default' }}"
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "‚úì Acci√≥n recibida: $ACTION (target: $TARGET)"
      
      - name: Ejecutar acci√≥n
        run: |
          ACTION="${{ steps.validate.outputs.action }}"
          TARGET="${{ steps.validate.outputs.target }}"
          
          case "$ACTION" in
            sync-content)
              echo "üîÑ Sincronizando contenido..."
              gh workflow run content-sync.yml -f apply=true || echo "‚ö†Ô∏è content-sync no disponible"
              ;;
            rebuild-dashboard)
              echo "üìä Reconstruyendo dashboard..."
              gh workflow run health-dashboard.yml || true
              ;;
            run-verifications)
              echo "‚úì Ejecutando verificaciones..."
              gh workflow run verify-home.yml || true
              gh workflow run verify-menus.yml || true
              gh workflow run verify-media.yml || true
              gh workflow run verify-settings.yml || true
              ;;
            cleanup-test-data)
              echo "üßπ Limpiando datos de prueba..."
              gh workflow run cleanup-test-posts.yml || echo "‚ö†Ô∏è cleanup workflow no disponible"
              ;;
            *)
              echo "‚ùå Acci√≥n desconocida: $ACTION"
              exit 1
              ;;
          esac
      
      - name: Resumen
        run: |
          {
            echo "--- API Automation Trigger ---"
            echo "Acci√≥n: ${{ steps.validate.outputs.action }}"
            echo "Target: ${{ steps.validate.outputs.target }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Triggered by: ${{ github.event_name }}"
            if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
              echo "Client: ${{ github.event.client_payload.client || 'unknown' }}"
            fi
          } | tee -a "$GITHUB_STEP_SUMMARY"
